import { useState, useEffect } from "react";
import { toast } from "sonner";
import { apiClient } from "@/lib/api";
import { useAuth } from "@/context/AuthContext";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Pencil, Trash2, Plus } from "lucide-react";

interface Product {
  id: string;
  name: string;
  description: string;
  price: number;
  category: string;
  sizes: string[];
  colors: string[];
  stock: number;
  images: Record<string, string[]>;
  packagingImage?: string;
  videoUrl?: string;
  created_at: string;
}

// Function to generate placeholder image
const getPlaceholderImage = (productName: string, color: string = 'argent') => {
  const bgColor = color === 'doré' ? 'FFD700' : 'C0C0C0';
  const svgContent = `
    <svg width='60' height='60' xmlns='http://www.w3.org/2000/svg'>
      <rect fill='#${bgColor}' width='60' height='60' rx='8'/>
      <text x='50%' y='50%' text-anchor='middle' dy='.3em' fill='white' font-family='Arial' font-size='8' font-weight='bold'>
        ${productName.substring(0, 6)}
      </text>
    </svg>
  `;
  
  const base64 = btoa(svgContent);
  return `data:image/svg+xml;base64,${base64}`;
};

const emptyProduct = {
  name: "",
  description: "",
  price: 0,
  category: "chaîne",
  sizes: [] as string[],
  colors: ["argent", "doré"],
  stock: 0,
  images: { argent: [], doré: [] } as Record<string, string[]>,
  packagingImage: "",
  videoUrl: ""
};

export default function AdminProducts() {
  const [products, setProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);
  const [dialogOpen, setDialogOpen] = useState(false);
  const [editing, setEditing] = useState<Product | null>(null);
  const [form, setForm] = useState(emptyProduct);
  const [sizesInput, setSizesInput] = useState("");
  const { user } = useAuth();

  useEffect(() => {
    fetchProducts();
  }, []);

  const fetchProducts = async () => {
    try {
      const data = await apiClient.getProducts();
      setProducts(data);
    } catch (error) {
      console.error('Failed to fetch products:', error);
      toast.error("Erreur lors du chargement des produits");
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (id: string) => {
    if (!confirm("Êtes-vous sûr de vouloir supprimer ce produit ?")) return;
    
    try {
      const token = localStorage.getItem('authToken');
      if (!token) return;
      
      await apiClient.deleteProduct(id, token);
      toast.success("Produit supprimé !");
      fetchProducts();
    } catch (error) {
      console.error('Delete error:', error);
      toast.error("Erreur lors de la suppression");
    }
  };

  const openEdit = (p: Product) => {
    setForm({
      name: p.name,
      description: p.description,
      price: p.price,
      category: p.category,
      sizes: p.sizes,
      colors: p.colors,
      stock: p.stock,
      images: p.images || { argent: [], doré: [] },
      packagingImage: p.packagingImage || "",
      videoUrl: p.videoUrl || ""
    });
    setSizesInput(p.sizes.join(", "));
    setDialogOpen(true);
  };

  const handleSave = async () => {
    if (!user) return;
    
    const token = localStorage.getItem('authToken');
    if (!token) return;

    const sizes = sizesInput.split(",").map((s) => s.trim()).filter(Boolean);
    const payload = { ...form, sizes };

    try {
      if (editing) {
        await apiClient.updateProduct(editing.id, payload, token);
        toast.success("Produit mis à jour !");
      } else {
        await apiClient.createProduct(payload, token);
        toast.success("Produit créé !");
      }
      setDialogOpen(false);
      fetchProducts();
    } catch (error) {
      console.error('Save error:', error);
      toast.error("Erreur lors de la sauvegarde");
    }
  };

  return (
    <div className="p-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="font-display text-3xl font-semibold">Produits</h1>
        <button
          onClick={() => setDialogOpen(true)}
          className="flex items-center gap-2 px-4 py-2 text-sm bg-btn text-btn-foreground hover:bg-btn-hover rounded-sm"
        >
          <Plus size={16} />
          Ajouter un produit
        </button>
      </div>

      {loading ? (
        <p className="text-muted-foreground">Chargement...</p>
      ) : (
        <div className="bg-background border rounded-sm">
          <table className="w-full">
            <thead>
              <tr className="bg-secondary text-left">
                <th className="px-4 py-3 font-medium">Image</th>
                <th className="px-4 py-3 font-medium">Nom</th>
                <th className="px-4 py-3 font-medium">Catégorie</th>
                <th className="px-4 py-3 font-medium">Prix (F CFA)</th>
                <th className="px-4 py-3 font-medium">Stock</th>
                <th className="px-4 py-3 font-medium w-24">Actions</th>
              </tr>
            </thead>
            <tbody>
              {products.map((p) => (
                <tr key={p.id} className="border-t hover:bg-secondary/50">
                  <td className="px-4 py-3">
                    {p.images && Object.keys(p.images).length > 0 && (
                      <img 
                        src={getPlaceholderImage(p.name, Object.keys(p.images)[0])} 
                        alt={p.name}
                        className="w-12 h-12 rounded-sm object-cover border"
                      />
                    )}
                  </td>
                  <td className="px-4 py-3 font-medium">{p.name}</td>
                  <td className="px-4 py-3 capitalize">{p.category}</td>
                  <td className="px-4 py-3">{p.price} F CFA</td>
                  <td className="px-4 py-3">{p.stock}</td>
                  <td className="px-4 py-3">
                    <div className="flex gap-2">
                      <button onClick={() => openEdit(p)} className="p-1.5 hover:text-primary transition-colors"><Pencil size={15} /></button>
                      <button onClick={() => handleDelete(p.id)} className="p-1.5 hover:text-destructive transition-colors"><Trash2 size={15} /></button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
        <DialogContent className="sm:max-w-lg">
          <DialogHeader>
            <DialogTitle className="font-display text-xl">
              {editing ? "Modifier le produit" : "Nouveau produit"}
            </DialogTitle>
          </DialogHeader>
          <div className="space-y-4 mt-2">
            <div>
              <label className="block text-sm font-medium mb-1">Nom</label>
              <input value={form.name} onChange={(e) => setForm({ ...form, name: e.target.value })} className="w-full border rounded-sm px-3 py-2 text-sm bg-background focus:outline-none focus:ring-1 focus:ring-foreground" />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Description</label>
              <textarea value={form.description} onChange={(e) => setForm({ ...form, description: e.target.value })} className="w-full border rounded-sm px-3 py-2 text-sm bg-background focus:outline-none focus:ring-1 focus:ring-foreground" rows={2} />
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-sm font-medium mb-1">Prix (F CFA)</label>
                <input type="number" value={form.price} onChange={(e) => setForm({ ...form, price: Number(e.target.value) })} className="w-full border rounded-sm px-3 py-2 text-sm bg-background focus:outline-none focus:ring-1 focus:ring-foreground" />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Stock</label>
                <input type="number" value={form.stock} onChange={(e) => setForm({ ...form, stock: Number(e.target.value) })} className="w-full border rounded-sm px-3 py-2 text-sm bg-background focus:outline-none focus:ring-1 focus:ring-foreground" />
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Catégorie</label>
              <select value={form.category} onChange={(e) => setForm({ ...form, category: e.target.value })} className="w-full border rounded-sm px-3 py-2 text-sm bg-background focus:outline-none focus:ring-1 focus:ring-foreground">
                <option value="chaîne">Chaînes</option>
                <option value="bracelet">Bracelets</option>
                <option value="bague">Bagues</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Tailles (séparées par des virgules)</label>
              <input value={sizesInput} onChange={(e) => setSizesInput(e.target.value)} placeholder="ex: 40 cm, 45 cm, 50 cm" className="w-full border rounded-sm px-3 py-2 text-sm bg-background focus:outline-none focus:ring-1 focus:ring-foreground" />
            </div>
            <div>
              <label className="block text-sm font-medium mb-3">Couleurs</label>
              <div className="flex gap-3">
                {["argent", "doré"].map((c) => (
                  <label key={c} className="flex items-center gap-1.5 text-sm">
                    <input
                      type="checkbox"
                      checked={form.colors.includes(c)}
                      onChange={(e) => {
                        const colors = e.target.checked
                          ? [...form.colors, c]
                          : form.colors.filter((x) => x !== c);
                        setForm({ ...form, colors });
                      }}
                    />
                    <span className="capitalize">{c}</span>
                  </label>
                ))}
              </div>
            </div>

            {/* Images par couleur */}
            <div>
              <label className="block text-sm font-medium mb-3">Images par couleur (URLs séparées par des virgules)</label>
              <div className="space-y-3">
                {["argent", "doré"].map((color) => (
                  <div key={color}>
                    <label className="block text-sm font-medium mb-1 capitalize">{color}</label>
                    <input
                      type="text"
                      value={(form.images[color] || []).join(", ")}
                      onChange={(e) => {
                        const images = e.target.value.split(",").map(url => url.trim()).filter(Boolean);
                        setForm({ 
                          ...form, 
                          images: { 
                            ...form.images, 
                            [color]: images 
                          } 
                        });
                      }}
                      placeholder={`URLs des images ${color}, séparées par des virgules`}
                      className="w-full border rounded-sm px-3 py-2 text-sm bg-background focus:outline-none focus:ring-1 focus:ring-foreground"
                    />
                  </div>
                ))}
              </div>
            </div>

            {/* Vidéo et Packaging */}
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-sm font-medium mb-1">URL de la vidéo (optionnel)</label>
                <input
                  type="url"
                  value={form.videoUrl || ""}
                  onChange={(e) => setForm({ ...form, videoUrl: e.target.value })}
                  placeholder="https://exemple.com/video.mp4"
                  className="w-full border rounded-sm px-3 py-2 text-sm bg-background focus:outline-none focus:ring-1 focus:ring-foreground"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">URL de l'image packaging (optionnel)</label>
                <input
                  type="url"
                  value={form.packagingImage || ""}
                  onChange={(e) => setForm({ ...form, packagingImage: e.target.value })}
                  placeholder="https://exemple.com/packaging.jpg"
                  className="w-full border rounded-sm px-3 py-2 text-sm bg-background focus:outline-none focus:ring-1 focus:ring-foreground"
                />
              </div>
            </div>
            
            <button onClick={handleSave} className="w-full py-3 text-sm font-medium tracking-wider uppercase bg-btn text-btn-foreground hover:bg-btn-hover rounded-sm transition-colors mt-2">
              {editing ? "Enregistrer" : "Créer"}
            </button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
